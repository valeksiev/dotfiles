class ApplicationsController < ApplicationController

  def index 
    @applications = Client.all
    respond_to do |format|
      format.all { render :json => @applications.as_json(:root => false) }
    end
  end

  def create
    client_params = params.require(:application).permit!
    client_params.merge!(:owner => current_user)
    client_params[:price_models_attributes] = client_params.delete(:price_models)
    @application = Client.new(client_params)
    if @application.save
      result = { :application => @application, :status => 'success' }
    else
      result = { :errors => @application.errors, :status => 'error' }
    end
    respond_to do |format|
      format.all { render :json => result }
    end
  end

  def show
    @application = Client.find(params.require(:id))
    respond_to do |format|
      format.all { render :json => @application.as_json(:root => false, :include => [:hooks]) }
    end
  end

  def current
    @applications = current_user.clients 
    respond_to do |format|
      format.all { render :json => @applications.as_json(:root => false) }
    end
  end

  def current_school
    @applications = current_user.school.applications
    respond_to do |format|
      format.all { render :json => @applications.as_json(:root => false) }
    end
  end


  def avaliable_hooks
    respond_to do |format|
      format.all { render :json => ActionHook::ACCOUNT_TRIGGERS }
    end
  end

  def tech_config
    application = params.require(:application).permit!
    @application = Client.find(application.delete(:id))
    @application.hooks_config = application[:hooks_config]
    application[:hooks].map do |hook| 
      h = @application.hooks.where(:id => hook.delete(:id)).first || @application.hooks.new
      h.update_attributes(hook)
      h.save
    end
    @application.save
    respond_to do |format|
      format.all { render :json => {} }
    end
  end

  def launch
    application = Client.find(params.require(:id))
    hook = application.launch_hook.run(current_user)
    respond_to do |format|
      format.all { render :json => hook.as_json(:root => false).merge(:base_config => application.hooks_config, :processed_params => hook.processed_params) }
    end

  end

end
