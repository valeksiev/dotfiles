Application.controller 'ActivateCtrl', 
['$scope', '$window', '$rootScope', '$routeParams', 'Account', 'School', 'Session', 'FormHelper', 'Api', '$upload',
($scope, $window, $rootScope, $routeParams, Account, School, Session, FormHelper, Api, $upload) ->

  $scope.default_redirect = '/'
  new_school = false
  $scope.school = null

  $scope.$on '$viewContentLoaded', () ->
    $scope.initialize()

  $scope.initialize = () ->
    Account.get_by_activation_token($routeParams.token, (response) ->
      unless _.isEmpty(response.account)
        $scope.account = account
        $scope.account.avatar = '/assets/first_avatar.jpg'
        $scope.school = logo: '/assets/school_avatar_1.jpg'
      else
        $window.location.href = $scope.default_redirect
    )
    School.all((schools) ->
      $scope.schools = schools
    )
    console.log $scope.schools
    School.types((types) ->
      $scope.school_types = types
    )


  #
  # Display School registration form
  #
  $scope.$watch 'account_school_id', (new_data, old_data) ->
    if new_data is 'new'
      $('#waiting').fadeIn()
      if _.isEmpty($scope.school)
        Api.get('/schools/new', null, (res) ->
          $scope.school = res.data.school if _.has(res.data, 'school')
          $('#waiting').fadeOut(() ->
            $('#school_information').slideDown()
          )
        )
      else
        $('#waiting').fadeOut(() ->
          $('#school_information').slideDown()
        )
      new_school = true
    else
      $('#school_information').slideUp()
      new_school = false

  #
  # Upload files in rails
  #
  $scope.uploadFile = (model, property, files) ->
    for file in files
      $upload.upload(
        url: '/image/upload',
        file: file,
        data:
          name: name
      ).then((result) ->
        if result.data.status == 'success'
          $scope[model][property] = result.data.path
      )

  $scope.finish = () ->
    $window.location.href = '/'

  #
  # Submiting form
  #
  $scope.submitForm = (event) ->
    if new_school
      $scope.account.school = $scope.school
    else
      $scope.account.school_id = $scope.account_school_id

    Account.activate($scope.account, (response) ->
      if response.status == 'success'
        $scope.finish()
      else
        # display some errors
    )

    #Api.put(
      #"/accounts/activate/#{$routeParams.token}"
      #, {}
      #, data
      #, (response) ->
        #console.log 'Response from API', response
        #$scope.finish()
      #, (error) ->
        #console.log 'We could not save the account and the school try again', error
    #)
]
