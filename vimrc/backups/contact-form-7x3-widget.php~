<?php
/*
Plugin Name: Contact Forms 7 x3 widget 
Plugin URI: http://blog.strategy11.com/contact-form-7-widget/
Description: Use your Contact Form 7 forms in a Widget.
Author: Stephanie Wells, edited by Vladimir Aleksiev
Author URI: http://ionixdesign.com 
Version: 1.0
*/

class WP_Widget_Custom_CF7x3 extends WP_Widget {

	function WP_Widget_Custom_CF7x3() {
		$widget_ops = array( 'description' => __( "Display any form from Contact Forms 7") );
		$this->WP_Widget('custom_cf7', __('Contact Form 7x3'), $widget_ops);
	}

	function widget( $args, $instance ) {
    extract($args);
		$title = apply_filters('widget_title', empty($instance['title']) ? '' : $instance['title']);
    $widget_id = 'widget-' . $this->id_base . '-' . $this->number;    
		echo $before_widget;
    
    $titles = array();
    foreach($instance as $key => $form){
      $titles[$key] = $form['title'];
   }
    
    echo '<div class="titles">';
			foreach ($titles as $key => $title){
        echo '<div class="title title-'.strtolower($title).'" data-for="form-'.$key.'">';
        echo '<div class="icon"></div>';
        echo $title;
        echo '</div>';
      }
    echo '</div>';
    echo '<div class="clearboth"></div>';
    foreach($instance as $key => $form){
    ?>
    <div class="cf7_form_box" id="form-<?php echo $key ?>">
      <?php 
    	  $widget_text = empty($form['form']) ? '[contact-form 1 "Contact form 1"]' : stripslashes($form['form']);
    	  echo apply_filters('widget_text', $widget_text);
    	?>
    </div>
    <?php
    }
		echo $after_widget;
	}

	function update( $new_instance, $old_instance ) {
		return $new_instance;
	}

	function form( $instance ) { 
    //Defaults
    $defaults = array('title' => false, 'form' => '[contact-form 1 "Contact form 1"]');
    foreach($instance as $key => $form){
      $instance[$key] = wp_parse_args( (array) $form, $defaults );
    }
    for($i = 0; $i<3; $i++){
    ?>
    <h4>Form #<?php echo $i+1; ?></h4>
	<p><label for="<?php echo $this->get_field_id('title'); ?>"><?php _e('Title:') ?></label>
	<input type="text" class="widefat" id="<?php echo $this->get_field_id('title'); ?>" name="<?php echo $this->get_field_name('['.$i.'][title]'); ?>" value="<?php echo esc_attr( $instance[$i]['title'] ); ?>" /></p>

	<p><label for="<?php echo $this->get_field_id('form'); ?>"><?php _e('Contact Form 7 Tag:') ?></label>
	<input type="text" class="widefat" id="<?php echo $this->get_field_id('form'); ?>" name="<?php echo $this->get_field_name(('['.$i.'][form]')); ?>" value="<?php echo esc_attr( $instance[$i]['form'] ); ?>" /></p>
	
<?php
  }
	}
  
  function get_field_name($field_name) {
    return 'widget-' . $this->id_base . '[' . $this->number . ']'. $field_name;
  }
}

function register_cf7x3_widget(){
    register_widget('WP_Widget_Custom_CF7x3');
}

add_action("widgets_init", 'register_cf7x3_widget');
?>
