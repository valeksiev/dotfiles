Application.controller 'developer.AppAddCtrl', 
['$scope', '$rootScope', '$compile', '$location', 'RailsApi', 'Account', 'Blueprint', 
($scope, $rootScope, $compile, $location, RailsApi, Account, Blueprint) ->

  $scope.application = Blueprint.application
  $scope.price_model = Blueprint.price_model
  $scope.applications = []

  $scope.categories = [
    { id: 1, title: 'Category1' },
    { id: 2, title: 'Category2' }
  ]
  $scope.subjects = [
    { id: 1, title: 'Subject1' },
    { id: 2, title: 'Subject2' }
  ]

  $scope.$on '$viewContentLoaded', () ->
    $scope.initialize()

  $scope.initialize = () ->
    $scope.age = $('#age-slider').slider()


  $scope.times = (times) ->
    new Array(times)

  $scope.priceModelsCount = () ->
    $scope.application.length

  $scope.addPriceModel = (event) ->
    event.preventDefault()
    if $scope.application.price_models.length == 5
      return
    $scope.application.price_models.push($scope.price_model.constructor())

  $scope.uploadIcon = (files) ->
    RailsApi.upload_file(files[0], 'icon', (response) ->
      if _.has(response, 'data') and response.data.status == 'success'
        $scope.application.icon = response.data.path
    )

  $scope.uploadScreenshot = (files, index) ->
    RailsApi.upload_file(files[0], "#{Math.round()/1000}app_screenshot_#{index}", (response) ->
      if _.has(response, 'data') and response.data.status == 'success'
        $scope.application.screenshots[index] = response.data.path
    )

  $scope.setAges = () ->
    ages = $scope.age.slider('getValue')
    $scope.application.start_age = ages[0]
    $scope.application.end_age = ages[1]
    console.log $scope.application

  $scope.addApplication = (event) ->
    event.preventDefault()
    $scope.setAges()
    RailsApi.post(
      'applications', 
      {}, 
      {application: $scope.application}, 
      (data, status) ->
        if _.has(data, 'status') and _.has(data, 'application') and data.status == 'success'
          $location.path("/apps/#{data.application.id}/tech_config")
      ,
      (data, status, header, config) ->
        # TODO add validations and display erros
        console.log data, status
    )
]
