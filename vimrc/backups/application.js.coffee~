Application.factory 'Application', ['RailsApi', (RailsApi) ->

  Model = {}

  Model.arreify = (object) ->
    array = []
    for key, value of object
      array.push( { key: key, value: value })
    array

  Model.objectify = (array) ->
    object = {}
    for o in array
      object[o.key] = o.value
    object

  Model.objectify_application = (application) ->
    application.hooks_config.params = Model.objectify(application.hooks_config.params)
    application.hooks_config.headers = Model.objectify(application.hooks_config.headers)
    for hook in application.hooks
      hook.params = Model.objectify(hook.params)
      hook.headers = Model.objectify(hook.headers)
    application

  Model.arreify_application = (application) ->
    application.hooks_config.headers = Model.arreify(application.hooks_config.headers)
    application.hooks_config.params = Model.arreify(application.hooks_config.params)
    for hook in application.hooks
      hook.params = Model.arreify(hook.params)
      hook.headers = Model.arreify(hook.headers)
    application

  Model.get = (id, callback) ->
    RailsApi.get("/applications/#{id}", {}, (application) ->
      application = Model.arreify_application(application)
      console.log application
      callback(application)
    )

  Model.for_current_account = (callback) ->
    RailsApi.get('/applications/current', {}, (response) ->
      callback(response)
    )

  Model.for_current_school = (callback) ->
    RailsApi.get('/applications/current', {}, (response) ->
      callback(response)
    )


  Model.get_avaliable_hooks = (callback) ->
    RailsApi.get('/applications/avaliable_hooks', {}, (response) ->
      callback(response)
    )

  Model.save = (application, callback) ->
    application = Model.objectify_application(application)
    RailsApi.post('/applications/tech_config',
                  {},
                  {
                    application: {
                      id: application.id
                      hooks_config: application.hooks_config
                      hooks: application.hooks
                    }
                  },
                  (response) ->
                    callback(response)
    )

  Model.launch = (id, callback) ->
    RailsApi.get("/applications/launch/#{id}", {}, (hook) ->
      callback(hook)
    )

  Model.all = (callback) ->
    RailsApi.get('/applications', {}, (response) ->
      callback(response)
    )


  return Model
]

